#image: docker/compose:latest
image: docker

services:
    - docker:dind

variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2

stages:
    #- diagnose
    - setup-mongo
    - client-build
    - server-build
    - test-client
    - test-server

#diagnose-docker:
 #   stage: diagnose
  #  script:
   #     - docker info

Setup MongoDB:
    stage: setup-mongo
    script:
        - apk add --no-cache curl py3-pip
        - pip3 install docker-compose
        - cd "mongo"
        - docker-compose up -d --build
    services:
        - docker:dind
    #artifacts:
     #   paths:
      #  - mongo/data/db

Client Build:
    stage: client-build
    image: node:latest
    script:
        - cd "client"
        - npm install

Server Build:
    stage: server-build
    image: node:latest
    script:
        - cd "server"
        - npm install

Test Client:
    stage: test-client
    image: node:latest
    script:
        - cd "client"
        - npm install
        - npm test
    dependencies:
        - Client Build

Test Server:
    stage: test-server
    image: node:latest
    script:
        - cd "server"
        - npm install
        - npm test
    dependencies:
        - Server Build
        - Setup MongoDB
    variables:
        MONGO_URI: "mongodb://mongo:27017/UnoProgetto"